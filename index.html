<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Performance Data</title>
    <style>
        /* --- General Styling --- */
        :root {
            --primary-bg: #f4f7f9;
            --card-bg: #ffffff;
            --header-bg: #e9eef2;
            --text-color: #333333;
            --text-light: #555555;
            --border-color: #e1e1e1;
            --accent-color: #007bff;
            --hover-bg: #f0f8ff;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --average-bg: #f0f7ff;
            --average-text: #0066cc;
            --tab-active-bg: #ffffff;
            --tab-inactive-bg: #f0f0f0;
            --tab-hover-bg: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Header --- */
        .main-header {
            background-color: var(--card-bg);
            padding: 1.5rem 1rem; /* Mobile padding */
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .main-header h1 {
            margin: 0;
            font-size: 1.5rem; /* Mobile font size */
            color: var(--text-color);
        }

        .main-header p.header-subtitle {
            margin: 0.25rem 0 0;
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 400;
        }

        /* --- Main Content Layout --- */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem; /* Mobile padding */
        }

        .notes-container {
            width: 100%;
            max-width: 1200px;
            margin-bottom: 1rem;
        }

        .note {
            display: inline-block;
            background-color: var(--average-bg);
            color: var(--average-text);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin: 0;
            text-align: center;
        }

        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem; /* Mobile margin */
            width: 100%;
            max-width: 1200px;
            padding: 0.5rem 0;
            justify-content: center; /* Center tabs on mobile */
        }

        .tab-button {
            padding: 0.5rem 1rem; /* Mobile padding */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--tab-inactive-bg);
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.9rem; /* Mobile font size */
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex: 1 1 auto; /* Allow tabs to grow and shrink */
            min-width: fit-content; /* Ensure content fits */
            text-align: center;
        }

        /* Small screen adjustments */
        @media (max-width: 767px) {
            .tabs-nav {
                gap: 0.25rem;
                justify-content: flex-start; /* Align to start on very small screens */
            }
            
            .tab-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
                flex: 0 1 auto; /* Don't grow, but allow shrinking */
                min-width: 0; /* Allow full shrinking */
            }
        }

        .tab-button:hover {
            background-color: var(--tab-hover-bg);
        }

        .tab-button.active {
            background-color: var(--tab-active-bg);
            color: var(--accent-color);
            border-color: var(--accent-color);
            font-weight: 600;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            width: 100%;
            max-width: 1200px;
        }

        .tab-content.active {
            display: block;
        }

        /* --- Card Styling for each table --- */
        .data-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            width: 100%;
            overflow-x: auto;
            box-sizing: border-box;
        }

        /* --- Table Styling --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem; /* Mobile font size */
        }

        th, td {
            padding: 0.6rem 0.8rem; /* Mobile padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .rank-column {
            width: 40px;
            text-align: center;
            color: var(--accent-color);
            font-weight: 600;
        }

        th {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: #dde5eb;
        }

        th::after {
            content: '⇅';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }

        th.sort-asc::after { content: '↑'; opacity: 1; }
        th.sort-desc::after { content: '↓'; opacity: 1; }
        thead th {
            background-color: var(--header-bg);
            font-weight: 600;
            color: var(--text-light);
            text-transform: capitalize;
        }

        tbody tr:hover { background-color: var(--hover-bg); }
        td { color: var(--text-light); }
        tfoot tr { background-color: var(--average-bg); font-weight: 600; }
        tfoot td { color: var(--average-text) !important; border-top: 2px solid var(--border-color); }
        td.ausfall { color: #d9534f; font-style: italic; }

        /* Highlight for special values */
        td.highlight-red {
            color: #d9534f;
            font-weight: bold;
            background-color: #fff5f5;
            position: relative;
            cursor: help;
        }

        /* Tooltip styling */
        td.highlight-red::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        td.highlight-red:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* --- Responsive Design (Desktop) --- */
        @media (min-width: 768px) {
            .main-header {
                padding: 1.5rem 2rem;
            }
            .main-header h1 {
                font-size: 2rem;
            }
            .container {
                padding: 2rem;
            }
            .tabs-nav {
                margin-bottom: 2rem;
                justify-content: flex-start; /* Align to start on desktop */
                gap: 0.75rem;
            }
            .tab-button {
                padding: 0.75rem 1.5rem;
                font-size: 0.95rem;
                flex: 0 0 auto; /* Don't grow or shrink on desktop */
            }
            table {
                font-size: 0.95rem;
            }
            th, td {
                padding: 0.8rem 1rem;
            }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <h1>U12</h1>
        <p class="header-subtitle">Performance Data & Analysis</p>
    </header>

    <main id="container" class="container">
        <!-- Data cards will be dynamically inserted here by JavaScript -->
    </main>

    <script>
        const csvData = `Geschicklichkeit (18.06.2025),,,,Sprint - Flying Start (14.07.2014),,,,Sprint - Standing Start (14.07.2014),,,,
Name,ohne_Ball,mit_Ball,,Name,5m,10m,15m,30m,,Name,5m,10m,15m,30m
Bent,14.63,,,Bent,1.36,2.12,2.87,4.34,,Bent,1.49,2.71,2.92,4.83
Berkay,14.87,20.77,,Ricky,1.4,2.2,2.86,4.34,,Ricky,1.55,2.69,2.95,4.88
Ricky,14.98,22.06,,Eladji,1.38,2.21,2.87,4.35,,Eladji,1.52,2.74,2.89,5
Moritz,15.09,,,Berkay,1.42,2.21,2.89,4.43,,Berkay,1.59,2.86,3.05,5.24
Lorent,15.1,20.85,,Seyit,1.39,2.17,2.9,4.43,,Seyit,1.53,2.73,2.92,4.94
Noan,15.15,21.3,,Moritz,1.39,2.19,2.99,4.52,,Moritz,1.59,2.9,3.06,5.19
Eladji,15.58,21.85,,Lorent,1.48,2.21,3.01,4.53,,Lorent,1.56,2.83,3.08,5.16
Bob,15.69,21.73,,Theo,1.49,2.26,3.01,4.55,,Theo,1.58,2.75,3.07,5.13
Seyit,15.78,22.01,,Ilyas,1.47,2.27,3.05,4.65,,Ilyas,1.61,2.85,3.22,5.21
Florian,16.09,22.19,,Bob,1.46,2.23,3.07,4.69,,Bob,1.61,2.83,3.24,5.36
Ilyas,16.25,21.21,,Noan,1.46,2.24,3.17,4.69,,Noan,1.62,2.88,3.19,5.28
Ibo,,22.53,,Ben,1.48,2.28,3.13,4.74,,Ben,1.61,2.73,3.1,5.05
Ben,,22.71,,Ibo,1.46,2.27,3.15,4.76,,Ibo,Ausfall,,3.24,5.28
Max,,22.36,,Max,1.5,2.32,3.14,4.76,,Max,1.63,2.82,3.22,5.25
Theo,,,,Florian,1.58,2.37,3.18,4.8,,Florian,1.68,2.9,3.31,5.3`;

        function parseData(csv) {
            const lines = csv.trim().split('\n');
            const titles = lines[0].split(',,,,').map(t => t.trim()).filter(Boolean);
            const headerLine = lines[1].split(',');
            const datasets = [
                { title: titles[0], headers: headerLine.slice(0, 3).filter(h => h), data: [], colSlice: [0, 3] },
                { title: titles[1], headers: headerLine.slice(4, 9).filter(h => h), data: [], colSlice: [4, 9] },
                { title: titles[2], headers: headerLine.slice(10, 15).filter(h => h), data: [], colSlice: [10, 15] }
            ];
            const dataLines = lines.slice(2);
            dataLines.forEach(line => {
                const values = line.split(',');
                datasets.forEach(dataset => {
                    const rowValues = values.slice(dataset.colSlice[0], dataset.colSlice[1]);
                    if (rowValues[0] && rowValues[0].trim()) {
                        const rowObject = {};
                        dataset.headers.forEach((header, index) => {
                            rowObject[header] = rowValues[index] || '';
                        });
                        dataset.data.push(rowObject);
                    }
                });
            });
            return datasets;
        }

        function createBentOverview(datasets) {
            const bentData = {
                title: "Bent",
                headers: ['Test', 'Measurement', 'Value', 'Rank'],
                data: []
            };

            // 1. Gather existing data and ranks
            datasets.forEach(dataset => {
                const bentEntry = dataset.data.find(entry => entry.Name === 'Bent');
                if (bentEntry) {
                    Object.entries(bentEntry).forEach(([key, value]) => {
                        if (key !== 'Name' && value) {
                            const allValues = dataset.data
                                .map(entry => entry[key])
                                .filter(v => v && v.toLowerCase() !== 'ausfall')
                                .map(v => parseFloat(v))
                                .filter(n => !isNaN(n))
                                .sort((a, b) => a - b);
                            const rank = allValues.indexOf(parseFloat(value)) + 1;
                            const total = allValues.length;
                            if (rank > 0) {
                                bentData.data.push({
                                    Test: dataset.title.split(' (')[0],
                                    Measurement: key.replace(/_/g, ' '),
                                    Value: value,
                                    Rank: `${rank}/${total}`
                                });
                            }
                        }
                    });

                    // Calculate percentage difference between mit Ball and ohne Ball
                    if (bentEntry.ohne_Ball && bentEntry.mit_Ball) {
                        const ohneBall = parseFloat(bentEntry.ohne_Ball);
                        const mitBall = parseFloat(bentEntry.mit_Ball);
                        if (!isNaN(ohneBall) && !isNaN(mitBall)) {
                            const percentDifference = (((mitBall - ohneBall) / ohneBall) * 100).toFixed(1);
                            bentData.data.push({
                                Test: dataset.title.split(' (')[0],
                                Measurement: 'Ball Impact (%)',
                                Value: `+${percentDifference}%`,
                                Rank: '-'
                            });
                        }
                    }
                }
            });

            // 2. Calculate and add speed analysis for Bent
            const sprintData = datasets.find(d => d.title.includes('Sprint - Standing Start'));
            if (sprintData) {
                const bentSprintEntry = sprintData.data.find(entry => entry.Name === 'Bent');
                if (bentSprintEntry) {
                    const t5 = parseFloat(bentSprintEntry['5m']);
                    const t15 = parseFloat(bentSprintEntry['15m']);
                    const t30 = parseFloat(bentSprintEntry['30m']);

                    if (!isNaN(t5) && t5 > 0) {
                        const acceleration = ((2 * 5) / (t5 * t5)).toFixed(2);
                        bentData.data.push({
                            Test: 'Speed Analysis',
                            Measurement: 'Acceleration (m/s²)',
                            Value: acceleration,
                            Rank: "-"
                        });
                    }

                    if (!isNaN(t15) && !isNaN(t30) && t30 > t15) {
                        const topSpeed = (((30 - 15) / (t30 - t15)) * 3.6).toFixed(2);
                        bentData.data.push({
                            Test: 'Speed Analysis',
                            Measurement: 'Top Speed (km/h)',
                            Value: topSpeed,
                            Rank: "-"
                        });
                    }
                }
            }

            // 3. Calculate reaction time using difference between standing and flying start at 5m
            const flyingStartData = datasets.find(d => d.title.includes('Sprint - Flying Start'));
            const standingStartData = datasets.find(d => d.title.includes('Sprint - Standing Start'));

            if (flyingStartData && standingStartData) {
                const bentFlyingEntry = flyingStartData.data.find(entry => entry.Name === 'Bent');
                const bentStandingEntry = standingStartData.data.find(entry => entry.Name === 'Bent');

                if (bentFlyingEntry && bentStandingEntry) {
                    const flyingTime5m = parseFloat(bentFlyingEntry['5m']);
                    const standingTime5m = parseFloat(bentStandingEntry['5m']);

                    if (!isNaN(flyingTime5m) && !isNaN(standingTime5m)) {
                        const reactionTime = ((standingTime5m - flyingTime5m) * 1000).toFixed(0); // Convert to milliseconds
                        bentData.data.push({
                            Test: 'Reaction Analysis',
                            Measurement: 'Reaction Time (ms)',
                            Value: `${reactionTime}ms`,
                            Rank: "-"
                        });
                    }
                }
            }
            return bentData;
        }

        function calculateAverage(values) {
            const numericValues = values.map(v => parseFloat(v)).filter(n => !isNaN(n));
            if (numericValues.length === 0) return '';
            return (numericValues.reduce((a, b) => a + b) / numericValues.length).toFixed(2);
        }

        function compareValues(a, b) {
            const aStr = String(a).trim();
            const bStr = String(b).trim();

            const isSpecialA = aStr === '-' || aStr === '' || aStr.toLowerCase() === 'ausfall';
            const isSpecialB = bStr === '-' || bStr === '' || bStr.toLowerCase() === 'ausfall';

            if (isSpecialA && isSpecialB) return 0;
            if (isSpecialA) return 1;
            if (isSpecialB) return -1;

            const isRankA = /^\d+\/\d+$/.test(aStr);
            const isRankB = /^\d+\/\d+$/.test(bStr);
            if (isRankA && isRankB) {
                return parseInt(aStr.split('/')[0], 10) - parseInt(bStr.split('/')[0], 10);
            }
            if (isRankA) return -1;
            if (isRankB) return 1;

            const numA = parseFloat(aStr);
            const numB = parseFloat(bStr);
            if (!isNaN(numA) && !isNaN(numB)) {
                return numA - numB;
            }

            return aStr.localeCompare(bStr);
        }

        function updateRankings(table) {
            const hasRankColumn = !table.closest('.data-card').dataset.noRank;
            if (!hasRankColumn) return;
            table.querySelectorAll('tbody tr').forEach((row, index) => {
                row.cells[0].textContent = (index + 1) + '.';
            });
        }

        function sortTable(table, columnIndex, asc) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const hasRankColumn = !table.closest('.data-card').dataset.noRank;
            const sortColumnIndex = hasRankColumn ? columnIndex + 1 : columnIndex;

            table.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            table.querySelectorAll('th')[hasRankColumn ? columnIndex : columnIndex].classList.add(asc ? 'sort-asc' : 'sort-desc');

            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[sortColumnIndex].textContent;
                const cellB = rowB.cells[sortColumnIndex].textContent;
                return (asc ? 1 : -1) * compareValues(cellA, cellB);
            });

            rows.forEach(row => tbody.appendChild(row));
            updateRankings(table);
        }

        function switchTab(testName) {
            document.querySelectorAll('.tab-button').forEach(button => button.classList.toggle('active', button.dataset.test === testName));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.dataset.test === testName));
        }

        function createTabsNavigation(container, datasets) {
            const tabsNav = document.createElement('div');
            tabsNav.className = 'tabs-nav';
            datasets.forEach((dataset, index) => {
                const button = document.createElement('button');
                button.className = 'tab-button' + (index === 0 ? ' active' : '');
                button.textContent = dataset.title.split(' (')[0];
                button.dataset.test = dataset.title;
                button.addEventListener('click', () => switchTab(dataset.title));
                tabsNav.appendChild(button);
            });
            container.appendChild(tabsNav);
        }

        function createTableCard(container, dataset) {
            const card = document.createElement('div');
            card.className = 'data-card';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const hasRankColumn = dataset.title !== "Bent";
            if (!hasRankColumn) {
                card.dataset.noRank = true;
            }

            if (hasRankColumn) {
                const rankHeader = document.createElement('th');
                rankHeader.textContent = '#';
                rankHeader.className = 'rank-column';
                rankHeader.style.cursor = 'default';
                headerRow.appendChild(rankHeader);
            }

            dataset.headers.forEach((headerText, index) => {
                const th = document.createElement('th');
                th.textContent = headerText.replace(/_/g, ' ');
                th.addEventListener('click', () => {
                    const currentIsAsc = th.classList.contains('sort-asc');
                    sortTable(table, index, !currentIsAsc);
                });
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            dataset.data.forEach((rowData, rowIndex) => {
                const row = document.createElement('tr');
                if (hasRankColumn) {
                    const rankCell = document.createElement('td');
                    rankCell.textContent = (rowIndex + 1) + '.';
                    rankCell.className = 'rank-column';
                    row.appendChild(rankCell);
                }
                dataset.headers.forEach(header => {
                    const td = document.createElement('td');
                    const value = rowData[header];
                    td.textContent = value;
                    if (String(value).toLowerCase() === 'ausfall') {
                        td.className = 'ausfall';
                    } else if (dataset.title === 'Bent' && value === '2.92') {
                        td.className = 'highlight-red';
                        td.setAttribute('data-tooltip', '85.7 km/h');
                    }
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            if (hasRankColumn && dataset.data.length > 0) {
                const tfoot = document.createElement('tfoot');
                const averageRow = document.createElement('tr');
                averageRow.appendChild(document.createElement('td'));
                dataset.headers.forEach((header, index) => {
                    const td = document.createElement('td');
                    if (index === 0) {
                        td.textContent = 'Average';
                    } else {
                        td.textContent = calculateAverage(dataset.data.map(row => row[header]));
                    }
                    averageRow.appendChild(td);
                });
                tfoot.appendChild(averageRow);
                table.appendChild(tfoot);
            }
            card.appendChild(table);
            container.appendChild(card);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('container');
            const originalDatasets = parseData(csvData);
            const bentOverview = createBentOverview(originalDatasets);

            const displayDatasets = [bentOverview, ...originalDatasets];

            const notesContainer = document.createElement('div');
            notesContainer.className = 'notes-container';
            notesContainer.innerHTML = `<p class="note"><b>Note:</b> Speed analysis metrics in Bent's tab assume a standing start (0 km/h).</p>`;
            container.appendChild(notesContainer);

            createTabsNavigation(container, displayDatasets);

            displayDatasets.forEach((dataset, index) => {
                if (dataset.data.length > 0) {
                    const tabContent = document.createElement('div');
                    tabContent.className = 'tab-content' + (index === 0 ? ' active' : '');
                    tabContent.dataset.test = dataset.title;
                    createTableCard(tabContent, dataset);
                    container.appendChild(tabContent);
                }
            });

            if (displayDatasets.length > 1) {
                const firstTestTable = document.querySelector(`.tab-content[data-test="${displayDatasets[1].title}"] table`);
                if(firstTestTable) sortTable(firstTestTable, 1, true); // Sort by second data column (ohne_Ball)
            }
        });
    </script>

</body>
</html>