<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leistungsdaten der Athleten</title>
    <style>
        /* General Body Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        body.overlay-open {
            overflow: hidden; /* Prevent scrolling of background content when overlay is open */
        }

        /* Main Container */
        .container {
            max-width: 98%;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        h1, h2 {
            text-align: center;
            color: #1a2533;
            margin-bottom: 25px;
        }

        /* --- Explanation Box --- */
        .explanation-box {
            max-width: 800px;
            margin: 0 auto 30px auto;
            padding: 15px 20px;
            background-color: #eef2f7;
            border: 1px solid #d0d9e3;
            border-radius: 8px;
            font-size: 0.95em;
        }
        .explanation-box h3 {
            margin-top: 0;
            color: #1a2533;
        }
        .explanation-box p {
            margin-bottom: 10px;
        }
        .explanation-box ul {
            padding-left: 20px;
        }
        .explanation-box code {
            background-color: #e0e6eb;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }

        /* --- Leaderboard Section --- */
        #leaderboard-container {
            max-width: 800px;
            margin: 0 auto 40px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fdfdfd;
        }
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #leaderboard-list li {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #leaderboard-list li:last-child {
            border-bottom: none;
        }
        #leaderboard-list .rank {
            font-size: 1.2em;
            font-weight: bold;
            color: #5d6d7e;
            width: 40px;
        }
        #leaderboard-list .name {
            font-size: 1.1em;
            font-weight: 500;
            flex-grow: 1;
            cursor: pointer;
            transition: color 0.2s;
        }
        #leaderboard-list .name:hover {
            color: #2980b9;
        }
        #leaderboard-list .score {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        /* --- Player Spotlight Section --- */
        .player-spotlight-controls {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        #playerSelector {
            font-size: 1.1em;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #spotlight-card-container {
            display: none;
            margin-bottom: 30px;
        }
        #spotlight-card {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #fdfdfd;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        #spotlight-card h3 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            color: #1a2533;
        }
        #spotlight-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }
        #spotlight-card li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background-color: #f0f3f5;
            border-radius: 4px;
        }
        #spotlight-card li.clickable-exercise {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #spotlight-card li.clickable-exercise:hover {
            background-color: #e0e6eb;
        }
        #spotlight-card .label { color: #555; font-size: 0.9em; }
        #spotlight-card .result-group { display: flex; align-items: center; gap: 8px; }
        #spotlight-card .rank { font-size: 0.8em; color: #5d6d7e; font-weight: bold; }
        #spotlight-card .value { font-weight: bold; font-size: 1em; }
        #spotlight-card .value.failure { color: #d9534f; }
        #spotlight-card .value.no-data { color: #888; font-style: italic; font-weight: normal; }

        /* --- Overlay Section --- */
        .overlay-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .overlay-content {
            background-color: #fff;
            width: 100%;
            height: 100%;
            position: relative;
            overflow-y: auto;
            padding: 40px;
            box-sizing: border-box;
        }
        .overlay-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            color: #888;
            line-height: 1;
        }
        .overlay-close:hover { color: #000; }
        #overlay-table-container table {
            width: 100%;
            max-width: 800px; /* Optional: constrain table width for readability */
            margin: 20px auto;
            border-collapse: collapse;
        }
        #overlay-table-container th, #overlay-table-container td {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        #overlay-table-container th {
            background-color: #f2f2f2;
        }
        #overlay-title {
            text-align: center;
        }

        /* Card Layout Wrapper */
        .card-columns-wrapper { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .performance-column { flex: 1; min-width: 215px; background-color: #fdfdfd; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; }
        .column-header { color: #ffffff; font-weight: bold; padding: 10px 15px; font-size: 0.9em; text-align: center; margin: 0; }
        .cards-list { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .performance-card { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); font-size: 0.9em; }
        .rank-indicator { display: flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 50%; background-color: #5d6d7e; color: #fff; font-size: 0.75em; font-weight: bold; flex-shrink: 0; }
        .card-name { font-weight: 500; color: #444; flex-grow: 1; white-space: nowrap; }
        .card-value { font-weight: bold; color: #1a2533; background-color: #e9ecef; padding: 2px 6px; border-radius: 3px; }
        .performance-card.no-data .card-value, .performance-card.failure .card-value { background-color: transparent; }
        .performance-card.no-data .card-value { color: #888; font-style: italic; font-weight: normal; }
        .performance-card.failure .card-value { color: #d9534f; font-weight: bold; }

        .th-agility { background-color: #27ae60; }
        .th-sprint-flying-group { background-color: #2980b9; }
        .th-sprint-standing-group { background-color: #e67e22; }
        .th-difference { background-color: #8e44ad; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Leistungsdaten der Athleten</h1>

        <div class="explanation-box">
            <h3>Erklärung der Gesamtpunktzahl</h3>
            <p>Die Gesamtpunktzahl ist der <strong>Durchschnitt</strong> aller Z-Scores eines Athleten. Ein Z-Score misst, wie viele Standardabweichungen eine Leistung vom Durchschnitt der Gruppe entfernt ist. <strong>Ein höherer Wert ist immer besser.</strong></p>
            <ul>
                <li><strong>Z-Score von +2.0 (oder höher):</strong> Herausragende Leistung, gehört zu den Top ~2.5% der Gruppe.</li>
                <li><strong>Z-Score von +1.0:</strong> Stark überdurchschnittliche Leistung.</li>
                <li><strong>Z-Score von 0.0:</strong> Exakt durchschnittliche Leistung.</li>
                <li><strong>Z-Score von -1.0:</strong> Unterdurchschnittliche Leistung.</li>
                <li><strong>Z-Score von -2.0 (oder niedriger):</strong> Deutlich unterdurchschnittliche Leistung, gehört zu den schwächsten ~2.5% der Gruppe.</li>
            </ul>
            <p>Fehlende Werte ("Fehlversuch", "Keine Zeit") werden bestraft, indem eine Zeit verwendet wird, die 10% schlechter ist als die langsamste gemessene Zeit in dieser Übung. Dies führt zu einem stark negativen Z-Score für diese Übung.</p>
        </div>

        <div id="leaderboard-container">
            <h2>Gesamtrangliste</h2>
            <ol id="leaderboard-list"></ol>
        </div>

        <div class="player-spotlight-controls">
            <label for="playerSelector"><strong>Detailansicht eines Athleten:</strong></label>
            <select id="playerSelector"></select>
        </div>

        <div id="spotlight-card-container">
            <div id="spotlight-card"></div>
        </div>

        <h2 style="margin-top: 40px;">Vergleich nach Übung</h2>
        <div id="card-container" class="card-columns-wrapper"></div>
    </div>

    <div id="overlay" class="overlay-container">
        <div class="overlay-content">
            <span class="overlay-close">&times;</span>
            <h2 id="overlay-title"></h2>
            <div id="overlay-table-container"></div>
        </div>
    </div>

    <script>
        const originalAthletesData = [
            { name: "Ricky", agilityNoBall: 14.98, agilityWithBall: 22.06, sprint5f: 1.40, sprint10f: 1.55, sprint15f: 2.86, sprint30f: 2.95, sprint5s: 2.20, sprint10s: 2.69, sprint15s: 4.34, sprint30s: 4.88 },
            { name: "Ilyas", agilityNoBall: 16.25, agilityWithBall: 21.21, sprint5f: 1.47, sprint10f: 1.61, sprint15f: 3.05, sprint30f: 3.22, sprint5s: 2.27, sprint10s: 2.85, sprint15s: 4.65, sprint30s: 5.21 },
            { name: "Berkay", agilityNoBall: 14.87, agilityWithBall: 20.77, sprint5f: 1.42, sprint10f: 1.59, sprint15f: 2.89, sprint30f: 3.05, sprint5s: 2.21, sprint10s: 2.86, sprint15s: 4.43, sprint30s: 5.24 },
            { name: "Bob", agilityNoBall: 15.69, agilityWithBall: 21.73, sprint5f: 1.46, sprint10f: 1.61, sprint15f: 3.07, sprint30f: 3.24, sprint5s: 2.23, sprint10s: 2.83, sprint15s: 4.69, sprint30s: 5.36 },
            { name: "Ibo", agilityNoBall: "Keine Zeit", agilityWithBall: 22.53, sprint5f: 1.46, sprint10f: "Fehlversuch", sprint15f: 3.15, sprint30f: 3.24, sprint5s: 2.27, sprint10s: "Fehlversuch", sprint15s: 4.76, sprint30s: 5.28 },
            { name: "Ben", agilityNoBall: "Keine Zeit", agilityWithBall: 22.71, sprint5f: 1.48, sprint10f: 1.61, sprint15f: 3.13, sprint30f: 3.10, sprint5s: 2.28, sprint10s: 2.73, sprint15s: 4.74, sprint30s: 5.05 },
            { name: "Bent", agilityNoBall: 14.63, agilityWithBall: "Keine Zeit", sprint5f: 1.36, sprint10f: 1.49, sprint15f: 2.87, sprint30f: 2.92, sprint5s: 2.12, sprint10s: 2.71, sprint15s: 4.34, sprint30s: 4.83 },
            { name: "Seyit", agilityNoBall: 15.78, agilityWithBall: 22.01, sprint5f: 1.39, sprint10f: 1.53, sprint15f: 2.90, sprint30f: 2.92, sprint5s: 2.17, sprint10s: 2.73, sprint15s: 4.43, sprint30s: 4.94 },
            { name: "Moritz", agilityNoBall: 15.09, agilityWithBall: "Keine Zeit", sprint5f: 1.39, sprint10f: 1.59, sprint15f: 2.99, sprint30f: 3.06, sprint5s: 2.19, sprint10s: 2.90, sprint15s: 4.52, sprint30s: 5.19 },
            { name: "Noan", agilityNoBall: 15.15, agilityWithBall: 21.30, sprint5f: 1.46, sprint10f: 1.62, sprint15f: 3.17, sprint30f: 3.19, sprint5s: 2.24, sprint10s: 2.88, sprint15s: 4.69, sprint30s: 5.28 },
            { name: "Max", agilityNoBall: "Keine Zeit", agilityWithBall: 22.36, sprint5f: 1.50, sprint10f: 1.63, sprint15f: 3.14, sprint30f: 3.22, sprint5s: 2.32, sprint10s: 2.82, sprint15s: 4.76, sprint30s: 5.25 },
            { name: "Florian", agilityNoBall: 16.09, agilityWithBall: 22.19, sprint5f: 1.58, sprint10f: 1.68, sprint15f: 3.18, sprint30f: 3.31, sprint5s: 2.37, sprint10s: 2.90, sprint15s: 4.80, sprint30s: 5.30 },
            { name: "Theo", agilityNoBall: "Keine Zeit", agilityWithBall: "Keine Zeit", sprint5f: 1.49, sprint10f: 1.58, sprint15f: 3.01, sprint30f: 3.07, sprint5s: 2.26, sprint10s: 2.75, sprint15s: 4.55, sprint30s: 5.13 },
            { name: "Lorent", agilityNoBall: 15.10, agilityWithBall: 20.85, sprint5f: 1.48, sprint10f: 1.56, sprint15f: 3.01, sprint30f: 3.08, sprint5s: 2.21, sprint10s: 2.83, sprint15s: 4.53, sprint30s: 5.16 },
            { name: "Eladji", agilityNoBall: 15.58, agilityWithBall: 21.85, sprint5f: 1.38, sprint10f: 1.52, sprint15f: 2.87, sprint30f: 2.89, sprint5s: 2.21, sprint10s: 2.74, sprint15s: 4.35, sprint30s: 5.00 },
            { name: "Julius", agilityNoBall: "Keine Daten", agilityWithBall: "Keine Daten", sprint5f: "Keine Daten", sprint10f: "Keine Daten", sprint15f: "Keine Daten", sprint30f: "Keine Daten", sprint5s: "Keine Daten", sprint10s: "Keine Daten", sprint15s: "Keine Daten", sprint30s: "Keine Daten" },
            { name: "Moritz 15", agilityNoBall: "Keine Daten", agilityWithBall: "Keine Daten", sprint5f: "Keine Daten", sprint10f: "Keine Daten", sprint15f: "Keine Daten", sprint30f: "Keine Daten", sprint5s: "Keine Daten", sprint10s: "Keine Daten", sprint15s: "Keine Daten", sprint30s: "Keine Daten" },
            { name: "Moussa", agilityNoBall: "Keine Daten", agilityWithBall: "Keine Daten", sprint5f: "Keine Daten", sprint10f: "Keine Daten", sprint15f: "Keine Daten", sprint30f: "Keine Daten", sprint5s: "Keine Daten", sprint10s: "Keine Daten", sprint15s: "Keine Daten", sprint30s: "Keine Daten" }
        ];

        const layoutConfig = [
            { type: 'agility_pair', noBallKey: 'agilityNoBall', withBallKey: 'agilityWithBall' },
            { type: 'sprint_pair', distance: '5m', flyingKey: 'sprint5f', standingKey: 'sprint5s' },
            { type: 'sprint_pair', distance: '10m', flyingKey: 'sprint10f', standingKey: 'sprint10s' },
            { type: 'sprint_pair', distance: '15m', flyingKey: 'sprint15f', standingKey: 'sprint15s' },
            { type: 'sprint_pair', distance: '30m', flyingKey: 'sprint30f', standingKey: 'sprint30s' },
        ];

        const spotlightLabels = {
            agilityNoBall: 'Agilität: ohne Ball (s)', agilityWithBall: 'Agilität: mit Ball (s)',
            sprint5f: 'Sprint fliegend: 5m (s)', sprint10f: 'Sprint fliegend: 10m (s)',
            sprint15f: 'Sprint fliegend: 15m (s)', sprint30f: 'Sprint fliegend: 30m (s)',
            sprint5s: 'Sprint stehend: 5m (s)', sprint10s: 'Sprint stehend: 10m (s)',
            sprint15s: 'Sprint stehend: 15m (s)', sprint30s: 'Sprint stehend: 30m (s)',
        };

        // --- DATA PROCESSING PIPELINE ---

        function createCorrectedData(data) {
            return JSON.parse(JSON.stringify(data)).map(athlete => {
                const tempA = athlete.sprint30f;
                athlete.sprint30f = athlete.sprint15s;
                athlete.sprint15s = tempA;
                const tempB = athlete.sprint10f;
                athlete.sprint10f = athlete.sprint5s;
                athlete.sprint5s = tempB;
                return athlete;
            });
        }

        function processAthleteData(data) {
            const processedData = JSON.parse(JSON.stringify(data));
            const keysToProcess = Object.keys(spotlightLabels);
            const exerciseStats = {};
            const PENALTY_MARGIN = 1.10; // 10% Penalty

            keysToProcess.forEach(key => {
                const values = data.map(a => a[key]).filter(v => typeof v === 'number');
                if (values.length > 1) {
                    const mean = values.reduce((sum, v) => sum + v, 0) / values.length;
                    const stdDev = Math.sqrt(values.map(v => Math.pow(v - mean, 2)).reduce((sum, v) => sum + v, 0) / values.length);
                    const max = Math.max(...values);
                    exerciseStats[key] = { mean, stdDev: stdDev || 1, max };
                }
            });

            const penalizedData = processedData.map(athlete => {
                const newAthlete = { ...athlete };
                keysToProcess.forEach(key => {
                    if (typeof newAthlete[key] !== 'number' && exerciseStats[key]) {
                        newAthlete[key] = exerciseStats[key].max * PENALTY_MARGIN;
                    }
                });
                return newAthlete;
            });

            processedData.forEach(athlete => {
                const penalizedAthlete = penalizedData.find(a => a.name === athlete.name);
                athlete.ranks = {};
                let zScoreSum = 0;
                let exercisesCounted = 0;

                keysToProcess.forEach(key => {
                    const value = penalizedAthlete[key];
                    if (typeof value === 'number' && exerciseStats[key]) {
                        const { mean, stdDev } = exerciseStats[key];
                        const zScore = -1 * (value - mean) / stdDev;
                        zScoreSum += zScore;
                        exercisesCounted++;
                    }
                });
                athlete.averageZScore = exercisesCounted > 0 ? zScoreSum / exercisesCounted : 0;
            });
            
            keysToProcess.forEach(key => {
                const validEntries = processedData
                    .map(a => ({ name: a.name, value: a[key] }))
                    .filter(a => typeof a.value === 'number')
                    .sort((a, b) => a.value - b.value);
                validEntries.forEach((entry, index) => {
                    const athlete = processedData.find(a => a.name === entry.name);
                    if (athlete) athlete.ranks[key] = index + 1;
                });
            });

            processedData.sort((a, b) => b.averageZScore - a.averageZScore);
            processedData.forEach((athlete, index) => {
                athlete.overallRank = index + 1;
            });

            return processedData;
        }

        // --- UI BUILDING FUNCTIONS ---

        function buildLeaderboard(container, data) {
            container.innerHTML = '';
            data.forEach(athlete => {
                const li = document.createElement('li');
                const score = athlete.averageZScore;
                li.innerHTML = `
                    <span class="rank">${athlete.overallRank}.</span>
                    <span class="name">${athlete.name}</span>
                    <span class="score">${score.toFixed(2)}</span>
                `;
                container.appendChild(li);
            });
        }

        function createColumn(title, cssClass, cardData) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'performance-column';
            const header = document.createElement('h3');
            header.className = `column-header ${cssClass}`;
            header.textContent = title;
            const cardsList = document.createElement('div');
            cardsList.className = 'cards-list';
            
            cardData.sort((a, b) => a.sortValue - b.sortValue).forEach(data => {
                const card = document.createElement('div');
                card.className = 'performance-card';
                if (data.rank) {
                    const rankCircle = document.createElement('span');
                    rankCircle.className = 'rank-indicator';
                    rankCircle.textContent = data.rank;
                    card.appendChild(rankCircle);
                }
                card.innerHTML += `<span class="card-name">${data.name}</span> <span class="card-value">${data.displayValue}</span>`;
                cardsList.appendChild(card);
            });
            columnDiv.appendChild(header);
            columnDiv.appendChild(cardsList);
            return columnDiv;
        }

        const formatCardData = (data, key) => {
            return data.map(athlete => {
                const value = athlete[key];
                const rank = athlete.ranks[key];
                const result = { name: athlete.name, rank: rank, sortValue: 9999, displayValue: value };
                if (typeof value === 'number') {
                    result.sortValue = value;
                } else if (String(value).toLowerCase().includes('fehlversuch')) {
                    result.sortValue = 9998;
                }
                return result;
            }).filter(card => card.sortValue < 9998);
        };

        function buildLayout(container, data, originalData) {
            container.innerHTML = '';
            layoutConfig.forEach(config => {
                if (config.type === 'agility_pair') {
                    const noBallData = formatCardData(data, config.noBallKey);
                    const withBallData = formatCardData(data, config.withBallKey);
                    const agilityDiffData = originalData.map(athlete => {
                        const valNoBall = athlete[config.noBallKey];
                        const valWithBall = athlete[config.withBallKey];
                        const result = { name: athlete.name, sortValue: 9999, displayValue: "N/A" };
                        if (typeof valNoBall === 'number' && typeof valWithBall === 'number') {
                            result.sortValue = ((valWithBall - valNoBall) / valNoBall) * 100;
                            result.displayValue = result.sortValue.toFixed(1) + '%';
                        }
                        return result;
                    }).filter(card => card.sortValue < 9999);
                    container.appendChild(createColumn('Agilität: ohne Ball (s)', 'th-agility', noBallData));
                    container.appendChild(createColumn('Agilität: mit Ball (s)', 'th-agility', withBallData));
                    container.appendChild(createColumn('Agilität: Differenz (%)', 'th-difference', agilityDiffData));
                }
                if (config.type === 'sprint_pair') {
                    const flyingCardData = formatCardData(data, config.flyingKey);
                    const standingCardData = formatCardData(data, config.standingKey);
                    const sprintDiffData = originalData.map(athlete => {
                        const valF = athlete[config.flyingKey];
                        const valS = athlete[config.standingKey];
                        const result = { name: athlete.name, sortValue: 9999, displayValue: "N/A" };
                        if (typeof valF === 'number' && typeof valS === 'number') {
                            result.sortValue = ((valS - valF) / valF) * 100;
                            result.displayValue = result.sortValue.toFixed(1) + '%';
                        }
                        return result;
                    }).filter(card => card.sortValue < 9999);
                    container.appendChild(createColumn(`Fliegend: ${config.distance} (s)`, 'th-sprint-flying-group', flyingCardData));
                    container.appendChild(createColumn(`Stehend: ${config.distance} (s)`, 'th-sprint-standing-group', standingCardData));
                    container.appendChild(createColumn(`Differenz: ${config.distance} (%)`, 'th-difference', sprintDiffData));
                }
            });
        }
        
        function populatePlayerDropdown(selector, data) {
            selector.innerHTML = '<option value="">-- Athleten auswählen --</option>';
            const sortedByName = [...data].sort((a, b) => a.name.localeCompare(b.name));
            sortedByName.forEach(athlete => {
                const option = document.createElement('option');
                option.value = athlete.name;
                option.textContent = athlete.name;
                selector.appendChild(option);
            });
        }

        function displaySpotlightCard(athlete, container, originalAthlete) {
            let cardHTML = `<h3>${athlete.name}</h3><ul>`;
            const score = athlete.averageZScore;
            cardHTML += `
                <li style="background-color: #e8f5e9;">
                    <span class="label"><strong>Gesamtrang</strong></span>
                    <div class="result-group">
                        <span class="value"><strong>${athlete.overallRank}</strong></span>
                    </div>
                </li>
                <li style="background-color: #e8f5e9; margin-bottom: 10px;">
                    <span class="label"><strong>Gesamtpunktzahl (Z-Score)</strong></span>
                    <div class="result-group">
                        <span class="value"><strong>${score.toFixed(2)}</strong></span>
                    </div>
                </li>
            `;

            for (const key in spotlightLabels) {
                const label = spotlightLabels[key];
                const value = originalAthlete[key];
                const rank = athlete.ranks[key];
                let valueClass = '';
                if (typeof value !== 'number') {
                    const lc = String(value).toLowerCase();
                    if(lc.includes('fehlversuch')) valueClass = 'failure';
                    else valueClass = 'no-data';
                }
                cardHTML += `
                    <li data-key="${key}" class="clickable-exercise">
                        <span class="label">${label}</span>
                        <div class="result-group">
                            ${rank ? `<span class="rank">(Rang: ${rank})</span>` : ''}
                            <span class="value ${valueClass}">${value}</span>
                        </div>
                    </li>`;
            }
            cardHTML += `</ul>`;
            container.innerHTML = cardHTML;
        }

        function buildOverlayTable(key, data, titleEl, tableContainerEl) {
            titleEl.textContent = spotlightLabels[key];

            const rankedAthletes = data
                .filter(athlete => athlete.ranks && athlete.ranks[key] !== null && athlete.ranks[key] !== undefined)
                .sort((a, b) => a.ranks[key] - b.ranks[key]);

            let tableHTML = '<table><thead><tr><th>Rang</th><th>Name</th><th>Ergebnis (s)</th></tr></thead><tbody>';

            rankedAthletes.forEach(athlete => {
                const value = athlete[key];
                tableHTML += `
                    <tr>
                        <td>${athlete.ranks[key]}</td>
                        <td>${athlete.name}</td>
                        <td>${value.toFixed(2)}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            tableContainerEl.innerHTML = tableHTML;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const leaderboardList = document.getElementById('leaderboard-list');
            const cardContainer = document.getElementById('card-container');
            const playerSelector = document.getElementById('playerSelector');
            const spotlightContainer = document.getElementById('spotlight-card-container');
            const spotlightCard = document.getElementById('spotlight-card');
            const overlay = document.getElementById('overlay');
            const overlayClose = document.querySelector('.overlay-close');
            const overlayTitle = document.getElementById('overlay-title');
            const overlayTableContainer = document.getElementById('overlay-table-container');

            const correctedData = createCorrectedData(originalAthletesData);
            const finalAthleteData = processAthleteData(correctedData);
            
            buildLeaderboard(leaderboardList, finalAthleteData);
            buildLayout(cardContainer, finalAthleteData, correctedData);
            populatePlayerDropdown(playerSelector, finalAthleteData);

            // Add click handler for leaderboard names
            leaderboardList.addEventListener('click', (e) => {
                const nameElement = e.target.closest('.name');
                if (nameElement) {
                    const athleteName = nameElement.textContent;
                    playerSelector.value = athleteName;
                    playerSelector.dispatchEvent(new Event('change'));
                    
                    // Smooth scroll to detail view
                    const detailSection = document.querySelector('.player-spotlight-controls');
                    detailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });

            playerSelector.addEventListener('change', (e) => {
                const selectedName = e.target.value;
                if (selectedName) {
                    const athleteData = finalAthleteData.find(a => a.name === selectedName);
                    const originalAthleteData = correctedData.find(a => a.name === selectedName);
                    displaySpotlightCard(athleteData, spotlightCard, originalAthleteData);
                    spotlightContainer.style.display = 'block';
                } else {
                    spotlightContainer.style.display = 'none';
                }
            });

            spotlightCard.addEventListener('click', (e) => {
                const exerciseRow = e.target.closest('.clickable-exercise');
                if (exerciseRow) {
                    const key = exerciseRow.dataset.key;
                    buildOverlayTable(key, correctedData, overlayTitle, overlayTableContainer);
                    overlay.style.display = 'flex';
                    document.body.classList.add('overlay-open');
                }
            });

            overlayClose.addEventListener('click', () => {
                overlay.style.display = 'none';
                document.body.classList.remove('overlay-open');
            });

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                    document.body.classList.remove('overlay-open');
                }
            });
        });

    </script>
</body>
</html>